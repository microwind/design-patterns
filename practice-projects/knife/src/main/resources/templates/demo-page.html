<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åæ¥å£è°ƒç”¨ç¤ºä¾‹ (å®¢æˆ·ç«¯: ios1)</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            background: #f5f5f5;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .info p {
            margin: 8px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        .input-group textarea {
            font-family: 'Courier New', monospace;
            height: 100px;
            resize: vertical;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .flow-btn {
            background: #52c41a;
        }
        .flow-btn:hover {
            background: #73d13d;
        }
        .result {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            display: none;
            border: 1px solid #e8e8e8;
        }
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            border-color: #ffccc7;
        }
        .success {
            color: #52c41a;
            background: #f6ffed;
            border-color: #b7eb8f;
        }
    </style>
</head>
<body>
<h1>ğŸ” API ç­¾åæ¥å£è°ƒç”¨æµç¨‹æ¼”ç¤º</h1>
<p style="text-align: center; color: #666;">å®¢æˆ·ç«¯ AppCode: <strong style="color: #1890ff;">ios1</strong></p>

<div class="container">
    <h3>ğŸ“‹ åç«¯ä¸‹å‘çš„é…ç½®ä¿¡æ¯</h3>
    <div class="info">
        <p><strong>AppCode:</strong> <span id="displayAppCode" th:text="${appCode}">ios1</span></p>
        <p><strong>ç›®æ ‡æ¥å£è·¯å¾„:</strong> <span id="displayPath" th:text="${path}">/api/sign/submit-test</span></p>
        <p><strong>åŠ¨æ€ç›å€¼:</strong> <span id="displayDynamicSalt" th:text="${dynamicSalt}">ï¼ˆåç«¯ç”Ÿæˆï¼‰</span></p>
        <p><strong>ç›å€¼ç”Ÿæˆæ—¶é—´æˆ³:</strong> <span id="displayDynamicSaltTime" th:text="${dynamicSaltTime}">ï¼ˆåç«¯ç”Ÿæˆï¼‰</span></p>
        <p style="color: #52c41a; font-weight: bold;">âœ… ä»¥ä¸Šä¿¡æ¯ç”±åç«¯ç›´æ¥ä¸‹å‘ï¼Œæ— éœ€å‰ç«¯å†æ¬¡ç”Ÿæˆ</p>
    </div>
</div>

<div class="container">
    <h3>æ­¥éª¤ 1: ä½¿ç”¨åç«¯ä¸‹å‘çš„åŠ¨æ€ç›å€¼</h3>
    <div class="step">
        <p style="color: #666;">åç«¯å·²ç»ä¸ºæ‚¨ç”Ÿæˆäº†åŠ¨æ€ç›å€¼ï¼Œå¯ä»¥ç›´æ¥è¿›å…¥æ­¥éª¤ 2 ç”Ÿæˆç­¾åã€‚</p>
        <p style="color: #666;">å¦‚æœéœ€è¦é‡æ–°ç”ŸæˆåŠ¨æ€ç›å€¼ï¼Œå¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼š</p>
        <div class="input-group">
            <label>AppCode (åªè¯»)</label>
            <input type="text" id="appCode" th:value="${appCode}" value="ios1" readonly>
        </div>
        <div class="input-group">
            <label>ç›®æ ‡æ¥å£è·¯å¾„</label>
            <input type="text" id="targetPath" th:value="${path}" value="/api/sign/submit-test">
        </div>
        <button onclick="generateDynamicSalt()">ğŸ”„ é‡æ–°ç”ŸæˆåŠ¨æ€ç›å€¼</button>
        <div id="saltResult" class="result"></div>
    </div>
</div>

<div class="container">
    <h3>æ­¥éª¤ 2: ç”Ÿæˆç­¾å</h3>
    <div class="step">
        <div class="input-group">
            <label>æ˜¯å¦æºå¸¦å‚æ•°</label>
            <select id="withParams">
                <option value="false">å¦ï¼ˆä¸å¸¦å‚æ•°ï¼‰</option>
                <option value="true">æ˜¯ï¼ˆå¸¦å‚æ•°ï¼‰</option>
            </select>
        </div>
        <div class="input-group" id="paramsGroup" style="display: none;">
            <label>è¯·æ±‚å‚æ•° (JSON æ ¼å¼)</label>
            <textarea id="requestParams">{"userId": 88888, "amount": 299.99, "orderName": "æ¼”ç¤ºè®¢å•"}</textarea>
        </div>
        <button onclick="generateSignature()" id="signBtn" disabled>âœï¸ ç”Ÿæˆç­¾å</button>
        <div id="signResult" class="result"></div>
    </div>
</div>

<div class="container">
    <h3>æ­¥éª¤ 3: æäº¤æ•°æ®ï¼ˆå¸¦ç­¾åéªŒè¯ï¼‰</h3>
    <div class="step">
        <button onclick="submitData()" id="submitBtn" disabled>ğŸ“¤ æäº¤æ•°æ®åˆ°æœåŠ¡å™¨</button>
        <div id="submitResult" class="result"></div>
    </div>
</div>

<div class="container">
    <h3>ğŸš€ ä¸€é”®æ‰§è¡Œå®Œæ•´æµç¨‹</h3>
    <div class="step">
        <button onclick="executeFullProcess()" class="flow-btn">æ‰§è¡Œå®Œæ•´ç­¾åéªŒè¯æµç¨‹</button>
        <div id="fullProcessResult" class="result"></div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    // é…ç½®ä¿¡æ¯ - ä»åç«¯è·å–
    const CONFIG = {
        appCode: /*[[${appCode}]]*/ 'ios1',
        baseUrl: window.location.origin
    };

    // å­˜å‚¨æµç¨‹ä¸­çš„æ•°æ® - åˆå§‹åŒ–ä½¿ç”¨åç«¯ä¸‹å‘çš„åŠ¨æ€ç›å€¼
    let state = {
        dynamicSalt: /*[[${dynamicSalt}]]*/ null,
        dynamicSaltTime: /*[[${dynamicSaltTime}]]*/ null,
        sign: null,
        signTime: null,
        targetPath: /*[[${path}]]*/ null,
        withParams: false,
        params: null
    };

    // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¦‚æœåç«¯å·²ä¸‹å‘åŠ¨æ€ç›å€¼ï¼Œåˆ™å¯ç”¨ç”Ÿæˆç­¾åæŒ‰é’®
    window.addEventListener('DOMContentLoaded', function() {
        if (state.dynamicSalt && state.dynamicSaltTime) {
            document.getElementById('signBtn').disabled = false;
            console.log('åç«¯å·²ä¸‹å‘åŠ¨æ€ç›å€¼ï¼Œå¯ä»¥ç›´æ¥ç”Ÿæˆç­¾å');
        }
    });
    /*]]>*/

    // ç›‘å¬æ˜¯å¦å¸¦å‚æ•°çš„é€‰æ‹©
    document.getElementById('withParams').addEventListener('change', function() {
        const paramsGroup = document.getElementById('paramsGroup');
        paramsGroup.style.display = this.value === 'true' ? 'block' : 'none';
    });

    // å·¥å…·å‡½æ•°ï¼šæ ¼å¼åŒ–æ˜¾ç¤ºç»“æœ
    function formatResult(data) {
        return JSON.stringify(data, null, 2);
    }

    // å·¥å…·å‡½æ•°ï¼šå»¶è¿Ÿ
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // æ­¥éª¤1: ç”ŸæˆåŠ¨æ€ç›å€¼
    async function generateDynamicSalt() {
        const saltResult = document.getElementById('saltResult');
        saltResult.style.display = 'block';
        saltResult.className = 'result';
        saltResult.innerHTML = 'â³ æ­£åœ¨ç”ŸæˆåŠ¨æ€ç›å€¼...';

        const appCode = document.getElementById('appCode').value;
        const path = document.getElementById('targetPath').value;
        state.targetPath = path;

        try {
            const response = await fetch(`${CONFIG.baseUrl}/api/sign/dynamic-salt-generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'appCode': appCode,
                    'path': path
                },
                body: JSON.stringify({})
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.code === 200) {
                state.dynamicSalt = result.data.dynamicSalt;
                state.dynamicSaltTime = result.data.dynamicSaltTime;

                saltResult.innerHTML = `âœ… åŠ¨æ€ç›å€¼ç”ŸæˆæˆåŠŸï¼
æ¶ˆæ¯: ${result.message}
æ•°æ®: ${formatResult(result.data)}`;
                saltResult.className = 'result success';

                // å¯ç”¨ç”Ÿæˆç­¾åæŒ‰é’®
                document.getElementById('signBtn').disabled = false;
            } else {
                throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');
            }
        } catch (error) {
            saltResult.innerHTML = `âŒ é”™è¯¯: ${error.message}`;
            saltResult.className = 'result error';
        }
    }

    // æ­¥éª¤2: ç”Ÿæˆç­¾å
    async function generateSignature() {
        if (!state.dynamicSalt) {
            alert('è¯·å…ˆç”ŸæˆåŠ¨æ€ç›å€¼');
            return;
        }

        const signResult = document.getElementById('signResult');
        signResult.style.display = 'block';
        signResult.className = 'result';
        signResult.innerHTML = 'â³ æ­£åœ¨ç”Ÿæˆç­¾å...';

        const withParams = document.getElementById('withParams').value === 'true';
        state.withParams = withParams;
        let params = null;

        try {
            if (withParams) {
                params = JSON.parse(document.getElementById('requestParams').value);
                state.params = params;
            }

            const response = await fetch(`${CONFIG.baseUrl}/api/sign/generate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'appCode': CONFIG.appCode,
                    'path': state.targetPath,
                    'dynamicSalt': state.dynamicSalt,
                    'dynamicSaltTime': state.dynamicSaltTime.toString(),
                    'withParams': withParams.toString()
                },
                body: withParams ? JSON.stringify(params) : JSON.stringify({})
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.code === 200) {
                state.sign = result.data.sign;
                state.signTime = result.data.time;

                signResult.innerHTML = `âœ… ç­¾åç”ŸæˆæˆåŠŸï¼
æ¶ˆæ¯: ${result.message}
æ•°æ®: ${formatResult(result.data)}`;
                signResult.className = 'result success';

                // å¯ç”¨æäº¤æŒ‰é’®
                document.getElementById('submitBtn').disabled = false;
            } else {
                throw new Error(result.message || 'ç”Ÿæˆç­¾åå¤±è´¥');
            }
        } catch (error) {
            signResult.innerHTML = `âŒ é”™è¯¯: ${error.message}`;
            signResult.className = 'result error';
        }
    }

    // æ­¥éª¤3: æäº¤æ•°æ®
    async function submitData() {
        if (!state.sign) {
            alert('è¯·å…ˆç”Ÿæˆç­¾å');
            return;
        }

        const submitResult = document.getElementById('submitResult');
        submitResult.style.display = 'block';
        submitResult.className = 'result';
        submitResult.innerHTML = 'â³ æ­£åœ¨æäº¤æ•°æ®...';

        try {
            const response = await fetch(`${CONFIG.baseUrl}/api/sign/submit-test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'appCode': CONFIG.appCode,
                    'path': state.targetPath,
                    'sign': state.sign,
                    'time': state.signTime.toString(),
                    'withParams': state.withParams.toString()
                },
                body: state.withParams ? JSON.stringify(state.params) : JSON.stringify({})
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.code === 200) {
                submitResult.innerHTML = `âœ… æ•°æ®æäº¤æˆåŠŸï¼
æ¶ˆæ¯: ${result.message}
å“åº”æ•°æ®: ${formatResult(result.data)}`;
                submitResult.className = 'result success';
            } else {
                submitResult.innerHTML = `âŒ æäº¤å¤±è´¥
æ¶ˆæ¯: ${result.message}
å“åº”æ•°æ®: ${formatResult(result.data)}`;
                submitResult.className = 'result error';
            }
        } catch (error) {
            submitResult.innerHTML = `âŒ é”™è¯¯: ${error.message}`;
            submitResult.className = 'result error';
        }
    }

    // å®Œæ•´æµç¨‹æ‰§è¡Œ
    async function executeFullProcess() {
        const fullProcessResult = document.getElementById('fullProcessResult');
        fullProcessResult.style.display = 'block';
        fullProcessResult.className = 'result';
        fullProcessResult.innerHTML = 'ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´ç­¾åéªŒè¯æµç¨‹...\n';

        try {
            // æ­¥éª¤1: ç”ŸæˆåŠ¨æ€ç›å€¼
            fullProcessResult.innerHTML += '\nğŸ“ æ­¥éª¤ 1: ç”ŸæˆåŠ¨æ€ç›å€¼...\n';
            await generateDynamicSalt();
            await sleep(800);

            if (!state.dynamicSalt) {
                throw new Error('åŠ¨æ€ç›å€¼ç”Ÿæˆå¤±è´¥');
            }
            fullProcessResult.innerHTML += 'âœ… æ­¥éª¤ 1 å®Œæˆ\n';

            // æ­¥éª¤2: ç”Ÿæˆç­¾å
            fullProcessResult.innerHTML += '\nğŸ“ æ­¥éª¤ 2: ç”Ÿæˆç­¾å...\n';
            await generateSignature();
            await sleep(800);

            if (!state.sign) {
                throw new Error('ç­¾åç”Ÿæˆå¤±è´¥');
            }
            fullProcessResult.innerHTML += 'âœ… æ­¥éª¤ 2 å®Œæˆ\n';

            // æ­¥éª¤3: æäº¤æ•°æ®
            fullProcessResult.innerHTML += '\nğŸ“ æ­¥éª¤ 3: æäº¤æ•°æ®...\n';
            await submitData();
            await sleep(800);

            fullProcessResult.innerHTML += '\nğŸ‰ å®Œæ•´æµç¨‹æ‰§è¡ŒæˆåŠŸï¼è¯·æŸ¥çœ‹ä¸Šæ–¹å„æ­¥éª¤çš„è¯¦ç»†ç»“æœã€‚';
            fullProcessResult.className = 'result success';

        } catch (error) {
            fullProcessResult.innerHTML += `\nâŒ æµç¨‹æ‰§è¡Œå¤±è´¥: ${error.message}`;
            fullProcessResult.className = 'result error';
        }
    }
</script>
</body>
</html>