<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç­¾åéªŒè¯æµç¨‹æ¼”ç¤º</title>
    <style>
        .container { max-width: 900px; margin: 50px auto; padding: 20px; font-family: Arial, sans-serif; }
        .step { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        .step h3 { margin-top: 0; color: #333; }
        .input-group { margin: 10px 0; }
        .input-group label { display: inline-block; width: 120px; font-weight: bold; }
        .input-group input, .input-group textarea { width: 500px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .input-group textarea { height: 80px; font-family: monospace; }
        .result { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .success { color: #155724; background: #d4edda; border: 1px solid #c3e6cb; }
        .error { color: #721c24; background: #f8d7da; border: 1px solid #f5c6cb; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; opacity: 0.6; }
        .flow-btn { background: #28a745; }
        .flow-btn:hover { background: #218838; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ” API ç­¾åéªŒè¯æµç¨‹æ¼”ç¤ºï¼ˆå®¢æˆ·ç«¯ï¼šios1ï¼‰</h2>
    <p>æœ¬é¡µé¢æ¨¡æ‹Ÿå®¢æˆ·ç«¯è°ƒç”¨ç­¾åæ¥å£çš„å®Œæ•´æµç¨‹ã€‚AppCode: <strong>ios1</strong></p>

    <!-- æ­¥éª¤1ï¼šç”ŸæˆåŠ¨æ€ç›å€¼ -->
    <div class="step">
        <h3>æ­¥éª¤ 1ï¼šç”ŸæˆåŠ¨æ€ç›å€¼</h3>
        <div class="input-group">
            <label>AppCode:</label>
            <input type="text" id="appCode" value="ios1" readonly>
        </div>
        <div class="input-group">
            <label>ç›®æ ‡æ¥å£è·¯å¾„:</label>
            <input type="text" id="submitPath" value="/api/sign/submit-test">
        </div>
        <button onclick="generateDynamicSalt()">ğŸ”‘ ç”ŸæˆåŠ¨æ€ç›å€¼</button>
        <div id="saltResult" class="result" style="display:none;"></div>
    </div>

    <!-- æ­¥éª¤2ï¼šç”Ÿæˆç­¾å -->
    <div class="step">
        <h3>æ­¥éª¤ 2ï¼šç”Ÿæˆç­¾å</h3>
        <div class="input-group">
            <label>æ˜¯å¦å¸¦å‚æ•°:</label>
            <select id="withParams">
                <option value="false">å¦ï¼ˆä¸å¸¦å‚æ•°ï¼‰</option>
                <option value="true">æ˜¯ï¼ˆå¸¦å‚æ•°ï¼‰</option>
            </select>
        </div>
        <div class="input-group" id="paramsGroup" style="display:none;">
            <label>è¯·æ±‚å‚æ•°:</label>
            <textarea id="requestParams">{"userId": 12345, "amount": 99.99, "orderName": "æµ‹è¯•è®¢å•"}</textarea>
        </div>
        <button onclick="generateSign()" id="signBtn" disabled>âœï¸ ç”Ÿæˆç­¾å</button>
        <div id="signResult" class="result" style="display:none;"></div>
    </div>

    <!-- æ­¥éª¤3ï¼šæäº¤æ•°æ® -->
    <div class="step">
        <h3>æ­¥éª¤ 3ï¼šæäº¤æ•°æ®ï¼ˆå¸¦ç­¾åéªŒè¯ï¼‰</h3>
        <button onclick="submitData()" id="submitBtn" disabled>ğŸ“¤ æäº¤æ•°æ®</button>
        <div id="submitResult" class="result" style="display:none;"></div>
    </div>

    <!-- å®Œæ•´æµç¨‹ -->
    <div class="step">
        <h3>ğŸš€ ä¸€é”®æ‰§è¡Œå®Œæ•´æµç¨‹</h3>
        <button onclick="executeFullFlow()" class="flow-btn">æ‰§è¡Œå®Œæ•´ç­¾åéªŒè¯æµç¨‹</button>
        <div id="fullFlowResult" class="result" style="display:none;"></div>
    </div>
</div>

<script>
    // å…¨å±€å˜é‡å­˜å‚¨ä¸­é—´ç»“æœ
    let dynamicSaltInfo = null; // åŠ¨æ€ç›å€¼ä¿¡æ¯
    let signInfo = null;        // ç­¾åä¿¡æ¯

    // ç›‘å¬æ˜¯å¦å¸¦å‚æ•°çš„é€‰æ‹©
    document.getElementById('withParams').addEventListener('change', function() {
        const paramsGroup = document.getElementById('paramsGroup');
        paramsGroup.style.display = this.value === 'true' ? 'block' : 'none';
    });

    // æ­¥éª¤1ï¼šç”ŸæˆåŠ¨æ€ç›å€¼
    async function generateDynamicSalt() {
        const appCode = document.getElementById('appCode').value;
        const path = document.getElementById('submitPath').value;
        const saltResultEl = document.getElementById('saltResult');
        saltResultEl.style.display = 'block';
        saltResultEl.className = 'result';
        saltResultEl.textContent = 'â³ æ­£åœ¨ç”ŸæˆåŠ¨æ€ç›å€¼...';

        try {
            const response = await fetch('/api/sign/dynamic-salt-generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Sign-appCode': appCode,
                    'Sign-path': path
                },
                body: JSON.stringify({})
            });

            if (!response.ok) throw new Error('ç”ŸæˆåŠ¨æ€ç›å€¼å¤±è´¥ï¼š' + response.status);
            const result = await response.json();

            if (result.code !== 200) throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');

            dynamicSaltInfo = result.data;

            saltResultEl.className = 'result success';
            saltResultEl.textContent = `âœ… åŠ¨æ€ç›å€¼ç”ŸæˆæˆåŠŸï¼
æ¥å£è·¯å¾„ï¼š${dynamicSaltInfo.path}
åŠ¨æ€ç›å€¼ï¼š${dynamicSaltInfo.dynamicSalt}
ç›å€¼æ—¶é—´æˆ³ï¼š${dynamicSaltInfo.dynamicSaltTime}
ç”Ÿæˆæ—¶é—´ï¼š${new Date(dynamicSaltInfo.dynamicSaltTime).toLocaleString()}`;

            // å¯ç”¨ç”Ÿæˆç­¾åæŒ‰é’®
            document.getElementById('signBtn').disabled = false;
        } catch (err) {
            saltResultEl.className = 'result error';
            saltResultEl.textContent = 'âŒ é”™è¯¯ï¼š' + err.message;
        }
    }

    // æ­¥éª¤2ï¼šç”Ÿæˆç­¾å
    async function generateSign() {
        if (!dynamicSaltInfo) {
            alert('è¯·å…ˆç”ŸæˆåŠ¨æ€ç›å€¼');
            return;
        }

        const signResultEl = document.getElementById('signResult');
        signResultEl.style.display = 'block';
        signResultEl.className = 'result';
        signResultEl.textContent = 'â³ æ­£åœ¨ç”Ÿæˆç­¾å...';

        const appCode = document.getElementById('appCode').value;
        const withParams = document.getElementById('withParams').value === 'true';
        let params = null;

        try {
            if (withParams) {
                params = JSON.parse(document.getElementById('requestParams').value);
            }

            const response = await fetch('/api/sign/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Sign-appCode': appCode,
                    'Sign-path': dynamicSaltInfo.path,
                    'Sign-dynamicSalt': dynamicSaltInfo.dynamicSalt,
                    'Sign-dynamicSaltTime': dynamicSaltInfo.dynamicSaltTime.toString(),
                    'Sign-withParams': withParams.toString()
                },
                body: withParams ? JSON.stringify(params) : JSON.stringify({})
            });

            if (!response.ok) throw new Error('ç”Ÿæˆç­¾åå¤±è´¥ï¼š' + response.status);
            const result = await response.json();

            if (result.code !== 200) throw new Error(result.message || 'ç”Ÿæˆå¤±è´¥');

            signInfo = result.data;
            signInfo.withParams = withParams;
            signInfo.params = params;

            signResultEl.className = 'result success';
            signResultEl.textContent = `âœ… ç­¾åç”ŸæˆæˆåŠŸï¼
æ¥å£è·¯å¾„ï¼š${signInfo.path}
ç­¾åå€¼ï¼š${signInfo.sign}
ç­¾åæ—¶é—´æˆ³ï¼š${signInfo.time}
ç­¾åæ—¶é—´ï¼š${new Date(signInfo.time).toLocaleString()}
è¿‡æœŸæ—¶é—´ï¼š${new Date(signInfo.expireTime).toLocaleString()}
æ˜¯å¦å¸¦å‚æ•°ï¼š${withParams ? 'æ˜¯' : 'å¦'}`;

            // å¯ç”¨æäº¤æŒ‰é’®
            document.getElementById('submitBtn').disabled = false;
        } catch (err) {
            signResultEl.className = 'result error';
            signResultEl.textContent = 'âŒ é”™è¯¯ï¼š' + err.message;
        }
    }

    // æ­¥éª¤3ï¼šæäº¤æ•°æ®
    async function submitData() {
        if (!signInfo) {
            alert('è¯·å…ˆç”Ÿæˆç­¾å');
            return;
        }

        const submitResultEl = document.getElementById('submitResult');
        submitResultEl.style.display = 'block';
        submitResultEl.className = 'result';
        submitResultEl.textContent = 'â³ æ­£åœ¨æäº¤æ•°æ®...';

        const appCode = document.getElementById('appCode').value;

        try {
            const headers = {
                'Content-Type': 'application/json',
                'Sign-appCode': appCode,
                'Sign-path': signInfo.path,
                'Sign-sign': signInfo.sign,
                'Sign-time': signInfo.time.toString(),
                'Sign-withParams': signInfo.withParams.toString()
            };

            const response = await fetch('/api/sign/submit-test', {
                method: 'POST',
                headers: headers,
                body: signInfo.withParams ? JSON.stringify(signInfo.params) : JSON.stringify({})
            });

            if (!response.ok) throw new Error('æäº¤å¤±è´¥ï¼š' + response.status);
            const result = await response.json();

            submitResultEl.className = result.code === 200 ? 'result success' : 'result error';
            submitResultEl.textContent = `${result.code === 200 ? 'âœ…' : 'âŒ'} ${result.message}
å“åº”æ•°æ®ï¼š${JSON.stringify(result.data, null, 2)}`;

        } catch (err) {
            submitResultEl.className = 'result error';
            submitResultEl.textContent = 'âŒ é”™è¯¯ï¼š' + err.message;
        }
    }

    // ä¸€é”®æ‰§è¡Œå®Œæ•´æµç¨‹
    async function executeFullFlow() {
        const fullFlowResultEl = document.getElementById('fullFlowResult');
        fullFlowResultEl.style.display = 'block';
        fullFlowResultEl.className = 'result';
        fullFlowResultEl.textContent = 'ğŸš€ å¼€å§‹æ‰§è¡Œå®Œæ•´æµç¨‹...\n';

        try {
            // æ­¥éª¤1ï¼šç”ŸæˆåŠ¨æ€ç›å€¼
            fullFlowResultEl.textContent += '\nğŸ“ æ­¥éª¤1ï¼šç”ŸæˆåŠ¨æ€ç›å€¼...\n';
            await generateDynamicSalt();
            await sleep(500);

            if (!dynamicSaltInfo) {
                throw new Error('åŠ¨æ€ç›å€¼ç”Ÿæˆå¤±è´¥');
            }
            fullFlowResultEl.textContent += 'âœ… åŠ¨æ€ç›å€¼ç”ŸæˆæˆåŠŸ\n';

            // æ­¥éª¤2ï¼šç”Ÿæˆç­¾å
            fullFlowResultEl.textContent += '\nğŸ“ æ­¥éª¤2ï¼šç”Ÿæˆç­¾å...\n';
            await generateSign();
            await sleep(500);

            if (!signInfo) {
                throw new Error('ç­¾åç”Ÿæˆå¤±è´¥');
            }
            fullFlowResultEl.textContent += 'âœ… ç­¾åç”ŸæˆæˆåŠŸ\n';

            // æ­¥éª¤3ï¼šæäº¤æ•°æ®
            fullFlowResultEl.textContent += '\nğŸ“ æ­¥éª¤3ï¼šæäº¤æ•°æ®...\n';
            await submitData();
            await sleep(500);

            fullFlowResultEl.className = 'result success';
            fullFlowResultEl.textContent += '\nğŸ‰ å®Œæ•´æµç¨‹æ‰§è¡Œå®Œæˆï¼è¯·æŸ¥çœ‹ä¸Šæ–¹å„æ­¥éª¤çš„è¯¦ç»†ç»“æœã€‚';

        } catch (err) {
            fullFlowResultEl.className = 'result error';
            fullFlowResultEl.textContent += '\nâŒ æµç¨‹æ‰§è¡Œå¤±è´¥ï¼š' + err.message;
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šå»¶è¿Ÿ
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
</script>
</body>
</html>